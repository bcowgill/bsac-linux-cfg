<html>
<script>
// An object to determine the animation frame frame rate (fps)
// inspired by article about animated particle effects and gaming monitor frame rates
// https://javascriptweekly.com/link/50578/1c006a79dc
// https://stackoverflow.com/questions/19764018/controlling-fps-with-requestanimationframe
// useDelta works well on Google Chrome and Safari.
// !useDelta for Firefox
function CalibrateFrameRate(useDelta, maxFrames) {
	var MILLIS = 1000;
	var RELIABLE_FRAME = 4; // for useDelta
	var DEFAULT_FRAMES = useDelta ? RELIABLE_FRAME + 1 : 20;
	var maxFrames = Math.max(maxFrames || DEFAULT_FRAMES, DEFAULT_FRAMES);
	var start;
	var prev = NaN;
	var now = NaN;
	var frames = 0;
	var calibrated = false;
	// var data = [];

	function calibrateFrameRate (timestamp) {
		var idAnimFrame = window.requestAnimationFrame(calibrateFrameRate);
		var stop = true;
		if (!start) {
			start = timestamp;
			stop = false;
		}
		else {
			if (frames < maxFrames) {
				prev = now;
				now = timestamp;
				frames += 1;
				stop = false;
			}
			else {
				calibrated = true;
			}
		}
		/*data.push({
			frames: frames, delta: now - prev, start: start, prev: prev, now: now
		});
		*/
		if (stop) {
			window.cancelAnimationFrame(idAnimFrame);
		}
	}
	window.requestAnimationFrame(calibrateFrameRate);

	return {
		isCalibrated: function () { return calibrated; },
		useDelta: function () { return !!useDelta; },
		frameRate: function () {
			var frameRate = NaN;
			if (useDelta && frames >= RELIABLE_FRAME) {
				frameRate = MILLIS / (now - prev);
			}
			if (!useDelta) {
				frameRate = MILLIS * frames / (now - start);
			}
			return frameRate;
		},
		// data: function () { return data; },
		delta: function () { return now - prev; },
		frames: function () { return frames; },
		maxFrames: function () { return maxFrames; },
		elapsed: function () { return now - start; }
	};

}

var useDelta = false;
var frameRate = new CalibrateFrameRate(useDelta);
var timer;

function showCalibration () {
	console.log('Frame Rate:', frameRate.frameRate(), frameRate.frames(), frameRate.elapsed(), frameRate.useDelta());
	if (frameRate.isCalibrated()) {
		clearInterval(timer);
		timer = undefined;
		// console.log('Calibraiton Data', frameRate.data());
	}
}

timer = setInterval(showCalibration, 10);
showCalibration();

</script>
</html>
