#!/bin/sh
# Git hook to prefix a commit message with the branch name.
# Also shows the last 3 commit log messages for reference
# And tells you how to abort the commit using VIM
# copy this file to your repository .git/hooks/prepare-commit-msg

# Prevents insertion of duplicate branch names in case of ammended commits
if [ "$3" ]; then
	exit;
fi

NAME=$(git branch | grep '*' | sed 's/* //')

if echo "$NAME" | grep 'rebasing'; then
	exit;
fi

MSG=`mktemp`
perl -e "my \$dir = shift; print qq{$NAME: \n# in dir: \$dir\n# VIM use ESC :cq to abort the commit, ESC :wq to write changes and quit, ESC u to undo last change and ESC :help for help.\n}" "`pwd`" | cat - "$1" >> "$MSG" \
	&& git log -3 | perl -pne 'BEGIN { print "# Previous few commits:\n"; }; s{\A}{#\t}xms' >> "$MSG" \
	&& mv "$MSG" "$1"
